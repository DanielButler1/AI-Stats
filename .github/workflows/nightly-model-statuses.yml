name: Nightly Model Status Refresh

on:
    schedule:
        - cron: "0 1 * * *"
    workflow_dispatch:

env:
    NODE_VERSION: 22

# These permissions only affect GITHUB_TOKEN; we’ll use an app token instead.
permissions:
    contents: read
    pull-requests: read

jobs:
    update-statuses:
        name: Update model statuses
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: false

            - name: Create GitHub App token (AI Stats Bot)
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.AI_STATS_APP_ID }}
                  private-key: ${{ secrets.AI_STATS_APP_PRIVATE_KEY }}

            - name: Compute bot commit identity
              id: bot
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  bot="${{ steps.app-token.outputs.app-slug }}[bot]"
                  id="$(gh api "/users/${bot}" --jq .id)"
                  email="${id}+${bot}@users.noreply.github.com"
                  echo "committer=${bot} <${email}>" >> "$GITHUB_OUTPUT"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Refresh model statuses
              run: pnpm data:update-statuses

            - name: Validate data
              run: pnpm validate:data

            - name: Create or update pull request
              id: cpr
              uses: peter-evans/create-pull-request@v8
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  commit-message: "chore: refresh model statuses"
                  title: "chore: refresh model statuses"
                  body: |
                      Automated nightly run to align model.status with announced/release/deprecation/retirement dates.
                      - Triggered by: ${{ github.workflow }} (run ${{ github.run_id }})
                  branch: chore/auto-model-statuses
                  delete-branch: true
                  committer: ${{ steps.bot.outputs.committer }}
                  author: ${{ steps.bot.outputs.committer }}
                  signoff: true

            - name: Wait for checks (all checks, not just required)
              if: steps.cpr.outputs.pull-request-number != ''
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  set -euo pipefail
                  pr="${{ steps.cpr.outputs.pull-request-number }}"

                  sleep 10

                  for i in $(seq 1 30); do
                    out="$(gh pr checks "$pr" --watch 2>&1)" && { echo "$out"; exit 0; }
                    echo "$out"

                    if echo "$out" | grep -qi "no checks reported"; then
                      echo "Checks not attached yet; retrying ($i/30)…"
                      sleep 5
                      continue
                    fi

                    # Some other real failure
                    exit 1
                  done

                  echo "Still no checks reported after retries."
                  exit 1

            - name: Merge PR (squash)
              if: steps.cpr.outputs.pull-request-number != ''
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: gh pr merge "${{ steps.cpr.outputs.pull-request-number }}" --squash --delete-branch
