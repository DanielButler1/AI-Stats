name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read

env:
    NODE_VERSION: 22

jobs:
    data:
        name: Validate data
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Validate data files
              run: pnpm validate:data && pnpm validate:pricing && pnpm validate:gateway

    check-paths:
        name: Check for data changes
        runs-on: ubuntu-latest
        outputs:
            data-changed: ${{ steps.filter.outputs.data }}
        steps:
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      data: 'apps/web/src/data/**'

    openapi-lint:
        name: OpenAPI lint
        runs-on: ubuntu-latest
        needs: data
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint OpenAPI spec
              run: pnpm openapi:lint

    apps:
        name: Apps ${{ matrix.app }}
        runs-on: ubuntu-latest
        needs: openapi-lint
        strategy:
            matrix:
                app: [api, docs, web]
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: API lint & build
              if: matrix.app == 'api'
              run: |
                  pnpm validate:api
                  pnpm --filter @ai-stats/gateway-api exec tsx scripts/pricing-simulator-cli.ts

            - name: Docs links
              if: matrix.app == 'docs'
              continue-on-error: true
              run: pnpm docs:links

            - name: Web lint & typecheck
              if: matrix.app == 'web'
              continue-on-error: true
              run: |
                  pnpm --filter @ai-stats/web lint
                  pnpm --filter @ai-stats/web typecheck

    importer:
        name: Run importer on main
        runs-on: ubuntu-latest
        needs:
            - data
            - check-paths
        if: needs.check-paths.outputs.data-changed == 'true' && github.ref == 'refs/heads/main'
        env:
            SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run importer (all sections)
              if: ${{ env.SUPABASE_SERVICE_ROLE_KEY != '' && env.NEXT_PUBLIC_SUPABASE_URL != '' }}
              env:
                  SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
                  NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
              run: pnpm --filter @ai-stats/web exec tsx scripts/importer/main.ts --section=all

    sdk-gen:
        name: Generate SDKs
        runs-on: ubuntu-latest
        needs: openapi-lint
        strategy:
            fail-fast: false
            matrix:
                include:
                    - sdk: ts
                      name: Generate TS SDK
                    - sdk: py
                      name: Generate PY SDK
                    - sdk: go
                      name: Generate GO SDK
                    - sdk: cpp
                      name: Generate CPP SDK
                    - sdk: csharp
                      name: Generate C# SDK
                    - sdk: rust
                      name: Generate Rust SDK
                    - sdk: php
                      name: Generate PHP SDK
                    - sdk: ruby
                      name: Generate Ruby SDK
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # --- DEBUG: show generator versions ---
            - name: Debug generator versions
              run: |
                  echo "Node: $(node -v)"
                  echo "pnpm: $(pnpm -v)"
                  # Adjust package names to whatever you actually use
                  if [ "${{ matrix.sdk }}" = "ts" ]; then
                    node -p "console.log('openapi-typescript-codegen:', require('openapi-typescript-codegen/package.json').version)" || true
                  fi
                  if [ "${{ matrix.sdk }}" = "csharp" ]; then
                    node -p "console.log('@openapitools/openapi-generator-cli:', require('@openapitools/openapi-generator-cli/package.json').version)" || true
                    pnpm exec openapi-generator-cli version || true
                  fi

            - name: Show openapi:gen scripts
              run: |
                  node -p "console.log('openapi:gen:ts =', JSON.parse(require('fs').readFileSync('package.json','utf8')).scripts['openapi:gen:ts'])" || true
                  node -p "console.log('openapi:gen:csharp =', JSON.parse(require('fs').readFileSync('package.json','utf8')).scripts['openapi:gen:csharp'])" || true

            # --- DEBUG: show key parts of the files *before* generation ---
            - name: Show TS ModerationRequestInput BEFORE
              if: matrix.sdk == 'ts'
              run: |
                  echo "==== TS ModerationRequestInput BEFORE ===="
                  sed -n '20,90p' packages/sdk-ts/src/gen/models/ModerationRequestInput.ts || echo "File missing"

            - name: Show C# solution + config BEFORE
              if: matrix.sdk == 'csharp'
              run: |
                  echo "==== C# AIStatsSdk.sln BEFORE ===="
                  sed -n '1,40p' packages/sdk-csharp/src/gen/AIStatsSdk.sln || echo "sln missing"
                  echo "==== C# README config BEFORE ===="
                  sed -n '1,40p' packages/sdk-csharp/src/gen/src/AIStatsSdk/README.md || echo "README missing"

            # --- ACTUAL GENERATION ---
            - name: Generate ${{ matrix.sdk }} SDK
              run: |
                  case "${{ matrix.sdk }}" in
                    ts) pnpm openapi:gen:ts ;;
                    py) pnpm openapi:gen:py ;;
                    go) pnpm openapi:gen:go ;;
                    cpp) pnpm openapi:gen:cpp ;;
                    csharp) pnpm openapi:gen:csharp ;;
                    rust) pnpm openapi:gen:rust ;;
                    php) pnpm openapi:gen:php ;;
                    ruby) pnpm openapi:gen:ruby ;;
                  esac

            # --- DEBUG: show key parts of the files *after* generation ---
            - name: Show TS ModerationRequestInput AFTER
              if: matrix.sdk == 'ts'
              run: |
                  echo "==== TS ModerationRequestInput AFTER ===="
                  sed -n '20,90p' packages/sdk-ts/src/gen/models/ModerationRequestInput.ts || echo "File missing"

            - name: Show C# solution + config AFTER
              if: matrix.sdk == 'csharp'
              run: |
                  echo "==== C# AIStatsSdk.sln AFTER ===="
                  sed -n '1,40p' packages/sdk-csharp/src/gen/AIStatsSdk.sln || echo "sln missing"
                  echo "==== C# README config AFTER ===="
                  sed -n '1,40p' packages/sdk-csharp/src/gen/src/AIStatsSdk/README.md || echo "README missing"

            # --- EXISTING CONSISTENCY CHECK ---
            - name: Ensure OpenAPI outputs up to date
              run: |
                  case "${{ matrix.sdk }}" in
                    ts) gen_path="packages/sdk-ts/src/gen" ; gen_script="openapi:gen:ts" ;;
                    py) gen_path="packages/sdk-py/src/gen" ; gen_script="openapi:gen:py" ;;
                    go) gen_path="packages/sdk-go/gen" ; gen_script="openapi:gen:go" ;;
                    cpp) gen_path="packages/sdk-cpp/src/gen" ; gen_script="openapi:gen:cpp" ;;
                    csharp) gen_path="packages/sdk-csharp/src/gen" ; gen_script="openapi:gen:csharp" ;;
                    rust) gen_path="packages/sdk-rust/src/gen" ; gen_script="openapi:gen:rust" ;;
                    php) gen_path="packages/sdk-php/src/gen" ; gen_script="openapi:gen:php" ;;
                    ruby) gen_path="packages/sdk-ruby/lib/gen" ; gen_script="openapi:gen:ruby" ;;
                  esac
                  echo "Checking that OpenAPI spec and '${{ matrix.sdk }}' SDK are up to date..."
                  if ! git diff --ignore-cr-at-eol --ignore-space-at-eol --quiet apps/docs/openapi/v1/openapi.json $gen_path; then
                    echo "::error::Detected *non-whitespace* differences in OpenAPI spec or generated '${{ matrix.sdk }}' SDK."
                    echo "::error::Please run 'pnpm $gen_script' locally and commit the updated files."
                    echo ""
                    echo "Full diff:"
                    git diff apps/docs/openapi/v1/openapi.json $gen_path
                    exit 1
                  fi
                  echo "OpenAPI spec and '${{ matrix.sdk }}' SDK are in sync."

    packages:
        name: Build & test SDK packages
        runs-on: ubuntu-latest
        needs: sdk-gen
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python for SDK builds
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Python build tooling
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install build pytest
                  python -m pip install -e packages/sdk-py

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build SDKs
              run: pnpm validate:packages

    deploy-preview-web:
        name: Deploy Web (Preview)
        runs-on: ubuntu-latest
        needs: apps
        if: github.event_name == 'pull_request'
        permissions:
            contents: read
            deployments: write
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Vercel CLI
              run: npm install --global vercel@latest

            - name: Deploy web to Vercel (preview)
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              if: ${{ env.VERCEL_PROJECT_ID != '' }}
              run: |
                  vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
                  vercel build --token=$VERCEL_TOKEN
                  vercel deploy --prebuilt --token=$VERCEL_TOKEN

    deploy:
        runs-on: ubuntu-latest
        needs:
            - apps
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: write
            deployments: write
        strategy:
            matrix:
                include:
                    - target: web
                      name: Deploy Web
                    - target: api
                      name: Deploy API
                    - target: docs
                      name: Deploy Docs
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            # ---------- WEB (Vercel) ----------
            - name: Setup pnpm
              if: matrix.target == 'web'
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Install dependencies
              if: matrix.target == 'web'
              run: pnpm install --frozen-lockfile

            - name: Install Vercel CLI
              if: matrix.target == 'web'
              run: npm install --global vercel@latest

            - name: Deploy web to Vercel (production)
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
              if: ${{ matrix.target == 'web' && env.VERCEL_PROJECT_ID != '' }}
              run: |
                  vercel pull --yes --environment=production --token=$VERCEL_TOKEN
                  vercel build --prod --token=$VERCEL_TOKEN
                  vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

            # ---------- API (Cloudflare Workers) ----------
            # Setup pnpm and install deps so wrangler can resolve imports
            - name: Setup pnpm
              if: matrix.target == 'api'
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Install dependencies (for API)
              if: matrix.target == 'api'
              run: pnpm install --frozen-lockfile

            # Wrangler CLI (you already had this)
            - name: Install Wrangler CLI
              if: matrix.target == 'api'
              run: npm install -g wrangler@4.45.0

            - name: Deploy API app to Cloudflare
              if: matrix.target == 'api'
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  workingDirectory: apps/api

            # ---------- DOCS ----------
            - name: Docs (Mintlify deploy is handled by GitHub App)
              if: matrix.target == 'docs'
              run: echo "Mintlify picks up main branch changes and deploys docs automatically."

    publish:
        name: Handle Versions
        runs-on: ubuntu-latest
        needs:
            - sdk-gen
            - packages
            - apps
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: write
            pull-requests: write
            id-token: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: package.json

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: pnpm

            - name: Upgrade npm (for trusted publishing)
              run: |
                  npm install -g npm@latest
                  node -v
                  npm -v

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Create release PR / publish
              id: changesets
              uses: changesets/action@v1
              with:
                  version: pnpm changeset:version
                  publish: pnpm changeset:publish
                  createGithubReleases: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Python (for PyPI publish)
              if: github.ref == 'refs/heads/main'
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12

            - name: Build Python SDK
              if: github.ref == 'refs/heads/main'
              working-directory: packages/sdk-py
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install build
                  python -m build

            - name: Publish Python SDK to PyPI (Trusted Publishing)
              if: github.ref == 'refs/heads/main'
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: packages/sdk-py/dist
                  skip-existing: true

            - name: Create GitHub releases from changelogs
              if: steps.changesets.outputs.published == 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  pnpm tsx scripts/changesets/create-github-releases-from-changelogs.ts
